---
import ProgressBar from "../components/ProgressBar";
import BaseLayout from "./BaseLayout.astro";
import Title from "../components/Title.astro";
import { SITE_METADATA } from "../config/site";

const { frontmatter, readTime, slug, sourcePath } = Astro.props;

const normalizedSlug = slug.replace(/^\/+/g, "").replace(/\/+$/g, "");
const canonicalPath = `/${normalizedSlug}/`;

const siteOrigin =
  Astro.site instanceof URL
    ? Astro.site
    : Astro.site
      ? new URL(Astro.site)
      : new URL(SITE_METADATA.siteUrl);

const articleUrl = new URL(canonicalPath, siteOrigin).href;

const articleStructuredData = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: frontmatter.title,
  description: frontmatter.description,
  datePublished: frontmatter.date.toISOString(),
  dateModified: frontmatter.date.toISOString(),
  author: {
    "@type": "Person",
    name: SITE_METADATA.author.name,
    url: SITE_METADATA.author.url,
  },
  publisher: {
    "@type": "Person",
    name: SITE_METADATA.author.name,
    url: SITE_METADATA.author.url,
  },
  mainEntityOfPage: articleUrl,
  inLanguage: SITE_METADATA.language,
  keywords: frontmatter.tags,
  image: new URL(SITE_METADATA.defaultImage, siteOrigin).href,
};

const breadcrumbStructuredData = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Home",
      item: siteOrigin.href,
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Archive",
      item: new URL("archive/1", siteOrigin).href,
    },
    {
      "@type": "ListItem",
      position: 3,
      name: frontmatter.title,
      item: articleUrl,
    },
  ],
};
---

<BaseLayout
  title={frontmatter.title}
  description={frontmatter.description}
  canonicalPath={canonicalPath}
  pubDate={frontmatter.date}
  type="article"
  structuredData={[articleStructuredData, breadcrumbStructuredData]}
>
  <ProgressBar client:idle />
  <article>
    <div class="center">
      <Title
        frontmatter={frontmatter}
        readTime={readTime}
        slug={slug}
        sourcePath={sourcePath}
      />
      <section class="markdown">
        <slot />
      </section>
    </div>
  </article>
</BaseLayout>
